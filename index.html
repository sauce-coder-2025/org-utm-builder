<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>F&P Ultimate UTM Builder</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .logo-container {
            max-width: 1200px;
            padding: 1rem;
            margin: 0 auto;
        }
        .logo-img {
            max-height: 40px;
            margin: 20px 0;
        }
        body {
            background-color: #f8f9fa;
            color: #212529;
            min-width: 1200px;
        }
        .container {
            max-width: 1600px;
            padding: 2rem;
            width: 100%;
        }
        /* Add this new class for the main content wrapper */
        .content-wrapper {
            display: flex;
            gap: 1rem;
            width: 100%;
        }
        /* Add this new class for the left column */
        .form-column {
            flex: 0 0 50%;
            max-width: 50%;
        }
        /* Add this new class for the right column */
        .log-column {
            flex: 0 0 50%;
            max-width: 50%;
        }
        .form-section {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            width: 100%;
            box-sizing: border-box;
        }
        .utm-log {
            width: 100%;
            background-color: #ffffff;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            height: calc(100vh - 150px);
            overflow-y: auto;
            position: sticky;
            top: 2rem;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        .auto-button {
            font-size: 10px !important;
            padding: 0px 6px !important;
            height: 20px !important;
            line-height: 20px !important;
            margin-right: 8px !important;
            background-color: #212529 !important;
            color: white !important;
            border: none !important;
        }
        .utm-table {
            width: 100%;
            margin-top: 1rem;
        }
        .utm-table th {
            background-color: #f8f9fa;
            padding: 0.75rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }
        .utm-url {
            max-width: 400px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center">Ultimate UTM Builder</h1>
        
        <!-- Authentication Container -->
        <div id="auth-container" class="text-center mb-4">
            <div class="form-section">
                <h3>Authentication</h3>
                <div class="mb-3">
                    <input type="email" class="form-control" id="email-input" placeholder="Enter your @fisherpaykel.com email">
                </div>
                <button class="btn btn-primary" onclick="authenticate()">Login</button>
            </div>
        </div>

        <!-- Notification -->
        <div id="notification" class="notification" style="display: none;">
            <div class="notification-content">
                <span id="notification-message"></span>
            </div>
        </div>

        <!-- Main App Container -->
        <div id="app-container" style="display: none;">
            <div class="row">
                <!-- Form Column -->
                <div class="col-md-8">
                    <!-- Campaign Organization Section -->
                    <div class="form-section">
                        <h3>Campaign Organization</h3>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="market" class="form-label">Market</label>
                                <select class="form-select" id="market" required>
                                    <option value="">Select...</option>
                                    <option value="AU">AU</option>
                                    <option value="NZ">NZ</option>
                                    <option value="US">US</option>
                                    <option value="UK">UK</option>
                                    <option value="SG">SG</option>
                                    <option value="CA">CA</option>
                                    <option value="GBL">Global</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="brand" class="form-label">Brand</label>
                                <select class="form-select" id="brand" required>
                                    <option value="">Select...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="productCategory" class="form-label">Product Category</label>
                                <select class="form-select" id="productCategory" onchange="updateSubCategories()" required>
                                    <option value="">Select...</option>
                                    <option value="Cooling">Cooling</option>
                                    <option value="Cooking">Cooking</option>
                                    <option value="Fabrice Care">Fabrice Care</option>
                                    <option value="Dishwashing">Dishwashing</option>
                                    <option value="Outdoor">Outdoor</option>
                                    <option value="Ventilation">Ventilation</option>
                                    <option value="Accessories">Accessories</option>
                                    <option value="Promotions">Promotions</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="subCategory" class="form-label">Sub Category</label>
                                <select class="form-select" id="subCategory">
                                    <option value="">Select...</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Campaign Timing Section -->
                    <div class="form-section">
                        <h3>Campaign Timing</h3>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="financialYear" class="form-label">Financial Year</label>
                                <select class="form-select" id="financialYear" required>
                                    <option value="">Select...</option>
                                    <option value="FY24">FY24</option>
                                    <option value="FY25">FY25</option>
                                    <option value="FY26">FY26</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="quarter" class="form-label">Quarter</label>
                                <select class="form-select" id="quarter" required>
                                    <option value="">Select...</option>
                                    <option value="Q1">Q1</option>
                                    <option value="Q2">Q2</option>
                                    <option value="Q3">Q3</option>
                                    <option value="Q4">Q4</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="month" class="form-label">Month</label>
                                <select class="form-select" id="month" required>
                                    <option value="">Select...</option>
                                    <option value="January">January</option>
                                    <option value="February">February</option>
                                    <option value="March">March</option>
                                    <option value="April">April</option>
                                    <option value="May">May</option>
                                    <option value="June">June</option>
                                    <option value="July">July</option>
                                    <option value="August">August</option>
                                    <option value="September">September</option>
                                    <option value="October">October</option>
                                    <option value="November">November</option>
                                    <option value="December">December</option>
                                </select>
                            </div>
                        </div>
                    </div>
<!-- Campaign Details Section -->
                    <div class="form-section">
                        <h3>Campaign Details</h3>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="channel" class="form-label">Channel</label>
                                <select class="form-select" id="channel" required>
                                    <option value="">Select...</option>
                                    <option value="Meta">Meta</option>
                                    <option value="Tiktok">Tiktok</option>
                                    <option value="LinkedIn">LinkedIn</option>
                                    <option value="Pinterest">Pinterest</option>
                                    <option value="DV360">DV360</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="col-md-6" id="otherChannelDiv" style="display: none;">
                                <label for="otherChannel" class="form-label">Other Channel</label>
                                <input type="text" class="form-control" id="otherChannel">
                            </div>
                            <div class="col-md-6">
                                <label for="channelType" class="form-label">Channel Type</label>
                                <select class="form-select" id="channelType" required>
                                    <option value="">Select...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="mediaObjective" class="form-label">Media Objective</label>
                                <select class="form-select" id="mediaObjective" required>
                                    <option value="">Select...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="buyType" class="form-label">Buy Type</label>
                                <select class="form-select" id="buyType" required>
                                    <option value="">Select...</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Campaign Structure Section -->
                    <div class="form-section">
                        <h3>Campaign Structure</h3>
                        <div class="row g-3">
                            <div class="col-12">
                                <label for="baseUrl" class="form-label">Base URL</label>
                                <input type="url" class="form-control" id="baseUrl" required>
                            </div>
                            <div class="col-md-6">
                                <label for="campaignName" class="form-label">Campaign Name</label>
                                <div class="input-group-auto">
                                    <button type="button" class="auto-button btn btn-sm" onclick="generateCampaignName()">Auto</button>
                                    <input type="text" class="form-control" id="campaignName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="adSet" class="form-label">Ad Set</label>
                                <div class="input-group-auto">
                                    <button type="button" class="auto-button btn btn-sm" onclick="generateAdSetName()">Auto</button>
                                    <input type="text" class="form-control" id="adSet">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="adName" class="form-label">Ad Name</label>
                                <input type="text" class="form-control" id="adName">
                            </div>
                        </div>
                    </div>
<!-- UTM Parameters Section -->
                    <div class="form-section">
                        <h3>UTM Parameters</h3>
                        <div class="row g-3">
                            <div class="col-12 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="manualUtmToggle" onchange="toggleManualUtm()">
                                    <label class="form-check-label" for="manualUtmToggle">Enable manual UTM parameter input</label>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="utmSource" class="form-label">UTM Source</label>
                                <input type="text" class="form-control" id="utmSource" readonly>
                                <small class="text-muted">Auto-populated from Channel</small>
                            </div>
                            <div class="col-md-6">
                                <label for="utmMedium" class="form-label">UTM Medium</label>
                                <input type="text" class="form-control" id="utmMedium" readonly>
                                <small class="text-muted">Auto-populated from Channel Type</small>
                            </div>
                            <div class="col-md-6">
                                <label for="utmCampaign" class="form-label">UTM Campaign</label>
                                <input type="text" class="form-control" id="utmCampaign" readonly>
                                <small class="text-muted">Auto-populated from Campaign Name</small>
                            </div>
                            <div class="col-md-6">
                                <label for="utmContent" class="form-label">UTM Content</label>
                                <input type="text" class="form-control" id="utmContent" readonly>
                                <small class="text-muted">Auto-populated from Ad Name</small>
                            </div>
                            <div class="col-md-6">
                                <label for="utmTerm" class="form-label">UTM Term</label>
                                <input type="text" class="form-control" id="utmTerm">
                                <small class="text-muted">Manual input field</small>
                            </div>
                            
                            <div class="col-12">
                                <button type="button" class="btn btn-primary" onclick="generateUTM()">Generate UTM</button>
                            </div>

                            <div id="generatedUtmSection" style="display: none;" class="col-12 mt-4">
                                <hr class="mb-4">
                                <label class="form-label">Generated UTM URL:</label>
                                <div class="generated-utm mb-3" id="generatedUtm"></div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-success" onclick="saveUTM()">Save UTM</button>
                                        <button type="button" class="btn btn-primary" onclick="copyToClipboard()">Copy to Clipboard</button>
                                    </div>
                                    <button type="button" class="btn btn-secondary" onclick="endSession()">
                                        <span id="endSaveSpinner" class="spinner-border spinner-border-sm me-2" style="display: none;"></span>
                                        Save & End Session
                                    </button>
                                </div>
                            </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- UTM Log Column -->
                <div class="col-md-4">
                    <div class="utm-log">
                        <h3>UTM Log</h3>
                        <table class="utm-table">
                            <thead>
                                <tr>
                                    <th>Actions</th>
                                    <th>Timestamp</th>
                                    <th>Created By</th>
                                    <th>Campaign</th>
                                    <th>UTM URL</th>
                                </tr>
                            </thead>
                            <tbody id="utmLog">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Start of JavaScript -->
    <script>
// Constants and Data Mappings
        const subCategories = {
            'Cooling': ['Refrigeration', 'Wine', 'Chest Freezer'],
            'Cooking': ['Ovens', 'Cooktops', 'Freestanding', 'Companions'],
            'Fabrice Care': ['Washing Machines', 'Dryers', 'Cabinets'],
            'Dishwashing': [],
            'Outdoor': ['Grills', 'Carts', 'Storage'],
            'Ventilation': [],
            'Accessories': ['Spare Parts', 'Accessories', 'Water Filters', 'Cleaning'],
            'Promotions': []
        };

        const marketBrands = {
            'AU': ['F&P', 'Haier', 'Haier Home', 'Home Solutions', 'DCS'],
            'NZ': ['F&P', 'Haier', 'Haier Home', 'Home Solutions'],
            'US': ['F&P', 'DCS'],
            'UK': ['F&P'],
            'CA': ['F&P', 'DCS'],
            'SG': ['F&P'],
            'GBL': ['F&P', 'Haier', 'Haier Home', 'Home Solutions', 'DCS']
        };

        const channelDependencies = {
            'Meta': {
                channelTypes: ['Paid Social', 'Social'],
                mediaObjectives: ['Attract', 'Engage', 'Convert', 'Retain'],
                buyTypes: ['Reach', 'Traffic', 'Conversion', 'Engagement']
            },
            'Tiktok': {
                channelTypes: ['Paid Social', 'Social'],
                mediaObjectives: ['Attract', 'Engage', 'Convert', 'Retain'],
                buyTypes: ['Reach', 'Traffic', 'Conversion', 'Engagement']
            },
            'LinkedIn': {
                channelTypes: ['Paid Social', 'Social'],
                mediaObjectives: ['Attract', 'Engage', 'Convert', 'Retain'],
                buyTypes: ['Reach', 'Traffic', 'Conversion', 'Engagement']
            },
            'Pinterest': {
                channelTypes: ['Paid Social', 'Social'],
                mediaObjectives: ['Attract', 'Engage', 'Convert', 'Retain'],
                buyTypes: ['Reach', 'Traffic', 'Conversion', 'Engagement']
            },
            'DV360': {
                channelTypes: ['Display', 'Video'],
                mediaObjectives: ['Attract', 'Engage', 'Convert', 'Retain'],
                buyTypes: ['Reach', 'Traffic', 'Conversion', 'Engagement']
            }
        };

        const marketBrandAbbreviations = {
            'AU': { 'F&P': 'FPAU', 'Haier': 'HAIAU', 'Haier Home': 'HHAU', 'Home Solutions': 'HSAU', 'DCS': 'DCSAU' },
            'NZ': { 'F&P': 'FPNZ', 'Haier': 'HAINZ', 'Haier Home': 'HHNZ', 'Home Solutions': 'HSNZ' },
            'US': { 'F&P': 'FPUS', 'DCS': 'DCSUS' },
            'UK': { 'F&P': 'FPUK' },
            'CA': { 'F&P': 'FPCA', 'DCS': 'DCSCA' },
            'SG': { 'F&P': 'FPSG' },
            'GBL': { 'F&P': 'FPGBL', 'Haier': 'HAIGBL', 'Haier Home': 'HHGBL', 'Home Solutions': 'HSGBL', 'DCS': 'DCSGBL' }
        };

        const mediaObjectiveAbbr = {
            'Attract': 'ATT',
            'Engage': 'ENG',
            'Convert': 'CON',
            'Retain': 'RET'
        };

        const monthAbbr = {
            'January': 'JAN', 'February': 'FEB', 'March': 'MAR',
            'April': 'APR', 'May': 'MAY', 'June': 'JUN',
            'July': 'JUL', 'August': 'AUG', 'September': 'SEP',
            'October': 'OCT', 'November': 'NOV', 'December': 'DEC'
        };

        const buyTypeAbbr = {
            'Reach': 'REACH',
            'Traffic': 'TRAFFIC',
            'Conversion': 'CONV',
            'Engagement': 'ENG',
            'Video Views': 'VIDV'
        };

        const categoryAbbr = {
            'Cooling': 'COOL',
            'Cooking': 'COOK',
            'Fabrice Care': 'FAB',
            'Dishwashing': 'DISH',
            'Outdoor': 'OUT',
            'Ventilation': 'VENT',
            'Accessories': 'ACC',
            'Promotions': 'PROMO'
        };

        const subCategoryAbbr = {
            'Refrigeration': 'REF',
            'Wine': 'WINE',
            'Chest Freezer': 'FREEZE',
            'Ovens': 'OVEN',
            'Cooktops': 'CTOP',
            'Freestanding': 'FREE',
            'Companions': 'COMP',
            'Washing Machines': 'WASH',
            'Dryers': 'DRY',
            'Cabinets': 'CAB',
            'Grills': 'GRILL',
            'Carts': 'CART',
            'Storage': 'STOR',
            'Spare Parts': 'SPARE',
            'Accessories': 'ACC',
            'Water Filters': 'FILT',
            'Cleaning': 'CLEAN'
        };
// Authentication Functions
        function authenticate() {
            const email = document.getElementById('email-input').value;
            if (email && email.endsWith('@fisherpaykel.com')) {
                const user = {
                    email: email,
                    name: email.split('@')[0].replace('.', ' ').replace(/\b\w/g, l => l.toUpperCase())
                };
                localStorage.setItem('utmBuilderUser', JSON.stringify(user));
                document.getElementById('auth-container').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
            } else {
                showNotification('Please use a valid @fisherpaykel.com email address');
            }
        }

        function checkAuth() {
            const user = JSON.parse(localStorage.getItem('utmBuilderUser'));
            if (user && user.email) {
                document.getElementById('auth-container').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
            }
        }

        // Form Update Functions
        function updateSubCategories() {
            const category = document.getElementById('productCategory').value;
            const subCategorySelect = document.getElementById('subCategory');
            const options = subCategories[category] || [];
            
            subCategorySelect.innerHTML = '<option value="">Select...</option>';
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                subCategorySelect.appendChild(optionElement);
            });
        }

        function updateBrandOptions() {
            const market = document.getElementById('market').value;
            const brandSelect = document.getElementById('brand');
            
            brandSelect.innerHTML = '<option value="">Select...</option>';
            if (market && marketBrands[market]) {
                marketBrands[market].forEach(brand => {
                    const option = document.createElement('option');
                    option.value = brand;
                    option.textContent = brand;
                    brandSelect.appendChild(option);
                });
            }
        }

        function updateChannelDependencies() {
            const channel = document.getElementById('channel').value;
            const channelTypeSelect = document.getElementById('channelType');
            const mediaObjectiveSelect = document.getElementById('mediaObjective');
            const buyTypeSelect = document.getElementById('buyType');
            
            function updateSelect(selectElement, options = []) {
                selectElement.innerHTML = '<option value="">Select...</option>';
                options.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    optionElement.textContent = option;
                    selectElement.appendChild(optionElement);
                });
            }

            const channelConfig = channelDependencies[channel] || {
                channelTypes: [],
                mediaObjectives: [],
                buyTypes: []
            };

            updateSelect(channelTypeSelect, channelConfig.channelTypes);
            updateSelect(mediaObjectiveSelect, channelConfig.mediaObjectives);
            updateSelect(buyTypeSelect, channelConfig.buyTypes);
        }

        // Generation Functions
        function generateCampaignName() {
            const market = document.getElementById('market').value;
            const brand = document.getElementById('brand').value;
            const mediaObjective = document.getElementById('mediaObjective').value;
            const financialYear = document.getElementById('financialYear').value;
            const quarter = document.getElementById('quarter').value;
            const month = document.getElementById('month').value;

            if (!market || !brand || !mediaObjective || !financialYear || !quarter || !month) {
                showNotification('Please fill in all required fields first');
                return;
            }

            const marketBrandCode = marketBrandAbbreviations[market][brand];
            const objectiveCode = mediaObjectiveAbbr[mediaObjective];
            const monthCode = monthAbbr[month];

            const campaignName = `${marketBrandCode}_${objectiveCode}_${financialYear}_${quarter}_${monthCode}`;
            document.getElementById('campaignName').value = campaignName;
            
            updateUTMFields();
        }

        function generateAdSetName() {
            const mediaObjective = document.getElementById('mediaObjective').value;
            const buyType = document.getElementById('buyType').value;
            const category = document.getElementById('productCategory').value;
            const subCategory = document.getElementById('subCategory').value;

            if (!mediaObjective || !buyType) {
                showNotification('Please select Media Objective and Buy Type first');
                return;
            }

            const objectiveCode = mediaObjectiveAbbr[mediaObjective];
            const buyTypeCode = buyTypeAbbr[buyType];
            const categoryCode = category ? categoryAbbr[category] || '' : '';
            const subCategoryCode = subCategory ? '_' + (subCategoryAbbr[subCategory] || '') : '';
            
            const adSetName = `${objectiveCode}_${buyTypeCode}${categoryCode ? '_' + categoryCode : ''}${subCategoryCode}`;
            document.getElementById('adSet').value = adSetName;
        }
// Toggle Functions
        function toggleOtherChannel() {
            const channelSelect = document.getElementById('channel');
            const otherChannelDiv = document.getElementById('otherChannelDiv');
            if (channelSelect.value === 'other') {
                otherChannelDiv.style.display = 'block';
            } else {
                otherChannelDiv.style.display = 'none';
            }
            updateUTMFields();
        }

        function toggleManualUtm() {
            const isManual = document.getElementById('manualUtmToggle').checked;
            const utmFields = ['utmSource', 'utmMedium', 'utmCampaign', 'utmContent'];
            
            utmFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                field.readOnly = !isManual;
                if (!isManual) {
                    updateUTMFields();
                }
            });
        }

        // UTM Handling Functions
        function updateUTMFields() {
            const isManual = document.getElementById('manualUtmToggle').checked;
            if (isManual) return;

            const channel = document.getElementById('channel');
            const otherChannel = document.getElementById('otherChannel');
            const channelType = document.getElementById('channelType');
            const campaignName = document.getElementById('campaignName');
            const adName = document.getElementById('adName');
            
            const channelValue = channel.value === 'other' ? otherChannel.value : channel.value;
            
            document.getElementById('utmSource').value = formatUtmValue(channelValue);
            document.getElementById('utmMedium').value = formatUtmValue(channelType.value);
            document.getElementById('utmCampaign').value = formatUtmValue(campaignName.value);
            document.getElementById('utmContent').value = formatUtmValue(adName.value);
        }

        function formatUtmValue(value) {
            if (!value) return '';
            return value.toLowerCase()
                       .replace(/\s+/g, '_')
                       .replace(/[^a-z0-9_-]/g, '');
        }
function saveUTM() {
    // Get user info
    const user = JSON.parse(localStorage.getItem('utmBuilderUser'));
    if (!user) {
        showNotification('Please log in first');
        return;
    }

    // Get current date/time
    const timestamp = new Date().toLocaleString();
    
    // Get the UTM string and check if it exists
    const utmString = document.getElementById('generatedUtm').textContent;
    if (!utmString) {
        showNotification('Please generate a UTM URL first');
        return;
    }

    // Collect all form data
    const formData = {
        timestamp: timestamp,
        creator: user.name,
        creatorEmail: user.email,
        market: document.getElementById('market').value,
        brand: document.getElementById('brand').value,
        productCategory: document.getElementById('productCategory').value,
        subCategory: document.getElementById('subCategory').value,
        financialYear: document.getElementById('financialYear').value,
        quarter: document.getElementById('quarter').value,
        month: document.getElementById('month').value,
        channel: document.getElementById('channel').value === 'other' ? 
                document.getElementById('otherChannel').value : 
                document.getElementById('channel').value,
        channelType: document.getElementById('channelType').value,
        mediaObjective: document.getElementById('mediaObjective').value,
        buyType: document.getElementById('buyType').value,
        baseUrl: document.getElementById('baseUrl').value,
        campaignName: document.getElementById('campaignName').value,
        adName: document.getElementById('adName').value,
        utmString: utmString,
        utmSource: document.getElementById('utmSource').value,
        utmMedium: document.getElementById('utmMedium').value,
        utmCampaign: document.getElementById('utmCampaign').value,
        utmContent: document.getElementById('utmContent').value,
        utmTerm: document.getElementById('utmTerm').value
    };

    // Send to Google Apps Script webhook
    fetch('YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Add to local UTM log
            const utmLog = document.getElementById('utmLog');
            const newRow = document.createElement('tr');
            
            newRow.innerHTML = `
                <td class="utm-actions">
                    <button class="btn btn-sm btn-outline-primary me-2 small-btn" onclick="copyUTM(this)">💾</button>
                    <button class="btn btn-sm btn-outline-danger small-btn" onclick="deleteUTM(this)">🚫</button>
                </td>
                <td>${timestamp}</td>
                <td>${user.name}</td>
                <td>${formData.campaignName}</td>
                <td class="utm-url" title="${utmString}">${utmString}</td>
            `;
            
            utmLog.appendChild(newRow);
            utmLog.parentElement.scrollTop = utmLog.parentElement.scrollHeight;
            showNotification('UTM saved successfully!');
        } else {
            showNotification('Error saving UTM: ' + data.message);
        }
    })
    .catch(error => {
        showNotification('Error saving UTM: ' + error.message);
        console.error('Save UTM error:', error);
    });
}
function endSession() {
    const utmRows = document.querySelectorAll('#utmLog tr');
    const endSaveButton = document.getElementById('endSaveButton');
    const endSaveSpinner = document.getElementById('endSaveSpinner');
    
    if (utmRows.length === 0) {
        showNotification('No UTMs to save. Please generate and save at least one UTM before ending session.');
        return;
    }

    // Show loading state
    endSaveButton.disabled = true;
    endSaveSpinner.style.display = 'inline-block';

    // Collect all UTM data with full details
    const utmData = Array.from(utmRows).map(row => {
        const user = JSON.parse(localStorage.getItem('utmBuilderUser'));
        return {
            timestamp: row.cells[1].textContent,
            creator: row.cells[2].textContent,
            creatorEmail: user.email,
            market: document.getElementById('market').value,
            brand: document.getElementById('brand').value,
            productCategory: document.getElementById('productCategory').value,
            subCategory: document.getElementById('subCategory').value,
            financialYear: document.getElementById('financialYear').value,
            quarter: document.getElementById('quarter').value,
            month: document.getElementById('month').value,
            channel: document.getElementById('channel').value === 'other' ? 
                    document.getElementById('otherChannel').value : 
                    document.getElementById('channel').value,
            channelType: document.getElementById('channelType').value,
            mediaObjective: document.getElementById('mediaObjective').value,
            buyType: document.getElementById('buyType').value,
            baseUrl: document.getElementById('baseUrl').value,
            campaignName: document.getElementById('campaignName').value,
            adName: document.getElementById('adName').value,
            utmString: row.cells[4].getAttribute('title'),
            utmSource: document.getElementById('utmSource').value,
            utmMedium: document.getElementById('utmMedium').value,
            utmCampaign: document.getElementById('utmCampaign').value,
            utmContent: document.getElementById('utmContent').value,
            utmTerm: document.getElementById('utmTerm').value
        };
    });

    // Send to Google Apps Script webhook
    fetch(process.env.WEBHOOK_URL, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Webhook-Secret': process.env.WEBHOOK_SECRET
        },
        body: JSON.stringify({ utms: utmData })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            clearForm();
            showNotification('UTMs saved successfully to Google Sheet!');
        } else {
            showNotification('Error saving UTMs: ' + data.message);
        }
    })
    .catch(error => {
        showNotification('Error saving UTMs: ' + error.message);
        console.error('Error:', error);
    })
    .finally(() => {
        // Reset loading state
        endSaveButton.disabled = false;
        endSaveSpinner.style.display = 'none';
    });
}
        function clearForm() {
            // Clear all form fields
            document.querySelectorAll('select, input').forEach(element => {
                element.value = '';
            });
            
            // Clear UTM log
            document.getElementById('utmLog').innerHTML = '';
            
            // Hide the generated UTM section
            document.getElementById('generatedUtmSection').style.display = 'none';
        
            // Reset other channel div
            document.getElementById('otherChannelDiv').style.display = 'none';
            
            // Reset UTM toggle
            document.getElementById('manualUtmToggle').checked = false;
            toggleManualUtm();
        }

        function generateUTM() {
            const baseUrl = document.getElementById('baseUrl').value;
            const utmSource = document.getElementById('utmSource').value;
            const utmMedium = document.getElementById('utmMedium').value;
            const utmCampaign = document.getElementById('utmCampaign').value;
            const utmContent = document.getElementById('utmContent').value;
            const utmTerm = document.getElementById('utmTerm').value;

            if (!baseUrl || !utmSource || !utmMedium || !utmCampaign) {
                showNotification('Please ensure all required fields are filled');
                return;
            }

            try {
                const url = new URL(baseUrl);
                url.searchParams.set('utm_source', utmSource);
                url.searchParams.set('utm_medium', utmMedium);
                url.searchParams.set('utm_campaign', utmCampaign);
                if (utmContent) url.searchParams.set('utm_content', utmContent);
                if (utmTerm) url.searchParams.set('utm_term', utmTerm);

                const generatedUtm = document.getElementById('generatedUtm');
                const generatedUtmSection = document.getElementById('generatedUtmSection');
                
                generatedUtm.textContent = url.toString();
                generatedUtmSection.style.display = 'block';
                
                generatedUtmSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } catch (error) {
                showNotification('Invalid URL format. Please check the Base URL.');
            }
        }
// UI Functions
        function showNotification(message, duration = 3000) {
            const notification = document.getElementById('notification');
            const notificationMessage = document.getElementById('notification-message');
            
            notificationMessage.textContent = message;
            notification.style.display = 'block';
            notification.classList.remove('hiding');
            
            setTimeout(() => {
                notification.classList.add('hiding');
                setTimeout(() => {
                    notification.style.display = 'none';
                    notification.classList.remove('hiding');
                }, 300);
            }, duration);
        }

        function copyToClipboard() {
            const utmString = document.getElementById('generatedUtm').textContent;
            navigator.clipboard.writeText(utmString)
                .then(() => showNotification('UTM copied to clipboard!'))
                .catch(err => showNotification('Failed to copy UTM: ' + err.message));
        }

        // UTM Management Functions
        function doPost(e) {
          try {
            // Parse the incoming data
            const data = JSON.parse(e.postData.contents);
            
            // Get the spreadsheet and sheet
            const ss = SpreadsheetApp.getActiveSpreadsheet();
            const sheet = ss.getSheetByName('UTM Log');
            
            if (!sheet) {
              throw new Error('UTM Log sheet not found');
            }
        
            // Add data to sheet
            sheet.appendRow([
              data.timestamp,
              data.creator,
              data.creatorEmail,
              data.market,
              data.brand,
              data.productCategory,
              data.subCategory,
              data.financialYear,
              data.quarter,
              data.month,
              data.channel,
              data.channelType,
              data.mediaObjective,
              data.buyType,
              data.baseUrl,
              data.campaignName,
              data.adName,
              data.utmString,
              data.utmSource,
              data.utmMedium,
              data.utmCampaign,
              data.utmContent,
              data.utmTerm
            ]);
            
            return ContentService.createTextOutput(
              JSON.stringify({ success: true, message: 'UTM saved successfully' })
            ).setMimeType(ContentService.MimeType.JSON);
            
          } catch (error) {
            return ContentService.createTextOutput(
              JSON.stringify({ success: false, message: error.toString() })
            ).setMimeType(ContentService.MimeType.JSON);
          }
        }

        function copyUTM(button) {
            const utmString = button.closest('tr').querySelector('.utm-url').title;
            navigator.clipboard.writeText(utmString)
                .then(() => showNotification('UTM copied to clipboard!'))
                .catch(err => showNotification('Failed to copy UTM: ' + err.message));
        }

        function deleteUTM(button) {
            const row = button.closest('tr');
            row.remove();
            showNotification('UTM deleted successfully');
        }

        // Initialize event listeners
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            
            // Add market change listener
            document.getElementById('market').addEventListener('change', updateBrandOptions);
            
            // Add channel change listener
            document.getElementById('channel').addEventListener('change', function() {
                updateChannelDependencies();
                toggleOtherChannel();
            });

            // Add event listeners for UTM field updates
            document.getElementById('channel').addEventListener('change', updateUTMFields);
            document.getElementById('otherChannel').addEventListener('input', updateUTMFields);
            document.getElementById('channelType').addEventListener('change', updateUTMFields);
            document.getElementById('campaignName').addEventListener('input', updateUTMFields);
            document.getElementById('adName').addEventListener('input', updateUTMFields);
        });
    </script>
</body>
</html>
