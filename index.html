<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ultimate UTM Builder</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* General body styling */
        body {
            background-color: #f8f9fa;
            padding: 20px;
            font-family: Arial, sans-serif;
        }

        /* Container for the entire app */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Grid layout for the main form and UTM log */
        .app-grid {
            display: grid;
            grid-template-columns: 1fr 400px; /* Main form (flexible) and UTM log (fixed) */
            gap: 24px;
            width: 100%;
        }

        /* Main form styling */
        .main-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-section {
            background: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* UTM log styling */
        .utm-log {
            position: sticky;
            top: 20px; /* Sticky positioning with 20px margin from the top */
            background: #ffffff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            height: calc(100vh - 40px); /* Ensures the log takes up available vertical space */
        }

        .utm-log h3 {
            margin-bottom: 15px;
        }

        /* Table styling inside the UTM log */
        .utm-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .utm-table th {
            background-color: #f8f9fa;
            padding: 10px;
            text-align: left;
            border-bottom: 2px solid #dee2e6;
        }

        .utm-table td {
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .utm-url {
            max-width: 350px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Notification styling */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: #007bff;
            color: #ffffff;
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.3s ease-out;
        }

        /* Buttons and input groups */
        .auto-button {
            font-size: 10px;
            padding: 0px 6px;
            height: 20px;
            line-height: 20px;
            margin-right: 8px;
            background-color: #212529;
            color: #ffffff;
            border: none;
        }

        .input-group-auto {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Form labels and inputs */
        .form-label {
            margin-bottom: 0.5rem;
        }

        /* Animations */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center">Ultimate UTM Builder</h1>

        <!-- Authentication Section -->
        <div id="auth-container" class="text-center mb-4">
            <div class="form-section">
                <h3>Authentication</h3>
                <div class="mb-3">
                    <input type="email" class="form-control" id="email-input" placeholder="Enter your @fisherpaykel.com email">
                </div>
                <button class="btn btn-primary" onclick="authenticate()">Login</button>
            </div>
        </div>

        <!-- Notification -->
        <div id="notification" class="notification" style="display: none;">
            <div class="notification-content">
                <span id="notification-message"></span>
            </div>
        </div>

        <!-- Main App Container -->
        <div id="app-container" style="display: none;">
            <div class="app-grid">
                <!-- Main Form Section -->
                <div class="main-form">
                    <div class="form-section">
                        <h3>Campaign Organization</h3>
                        <!-- Add form fields for Campaign Organization -->
                    </div>
                    <div class="form-section">
                        <h3>Campaign Timing</h3>
                        <!-- Add form fields for Campaign Timing -->
                    </div>
                    <div class="form-section">
                        <h3>Campaign Details</h3>
                        <!-- Add form fields for Campaign Details -->
                    </div>
                    <div class="form-section">
                        <h3>Campaign Structure</h3>
                        <!-- Add form fields for Campaign Structure -->
                    </div>
                    <div class="form-section">
                        <h3>UTM Parameters</h3>
                        <!-- Add form fields for UTM Parameters -->
                    </div>
                </div>

                <!-- UTM Log Section -->
                <div class="utm-log">
                    <h3>UTM Log</h3>
                    <table class="utm-table">
                        <thead>
                            <tr>
                                <th>Actions</th>
                                <th>Timestamp</th>
                                <th>Created By</th>
                                <th>Campaign</th>
                                <th>UTM URL</th>
                            </tr>
                        </thead>
                        <tbody id="utmLog">
                            <!-- Dynamically added rows go here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!-- Start of JavaScript -->
    <script>
// Constants and Data Mappings
        const subCategories = {
            'Cooling': ['Refrigeration', 'Wine', 'Chest Freezer'],
            'Cooking': ['Ovens', 'Cooktops', 'Freestanding', 'Companions'],
            'Fabrice Care': ['Washing Machines', 'Dryers', 'Cabinets'],
            'Dishwashing': [],
            'Outdoor': ['Grills', 'Carts', 'Storage'],
            'Ventilation': [],
            'Accessories': ['Spare Parts', 'Accessories', 'Water Filters', 'Cleaning'],
            'Promotions': []
        };

        const marketBrands = {
            'AU': ['F&P', 'Haier', 'Haier Home', 'Home Solutions', 'DCS'],
            'NZ': ['F&P', 'Haier', 'Haier Home', 'Home Solutions'],
            'US': ['F&P', 'DCS'],
            'UK': ['F&P'],
            'CA': ['F&P', 'DCS'],
            'SG': ['F&P'],
            'GBL': ['F&P', 'Haier', 'Haier Home', 'Home Solutions', 'DCS']
        };

        const channelDependencies = {
            'Meta': {
                channelTypes: ['Paid Social', 'Social'],
                mediaObjectives: ['Attract', 'Engage', 'Convert', 'Retain'],
                buyTypes: ['Reach', 'Traffic', 'Conversion', 'Engagement']
            },
            'Tiktok': {
                channelTypes: ['Paid Social', 'Social'],
                mediaObjectives: ['Attract', 'Engage', 'Convert', 'Retain'],
                buyTypes: ['Reach', 'Traffic', 'Conversion', 'Engagement']
            },
            'LinkedIn': {
                channelTypes: ['Paid Social', 'Social'],
                mediaObjectives: ['Attract', 'Engage', 'Convert', 'Retain'],
                buyTypes: ['Reach', 'Traffic', 'Conversion', 'Engagement']
            },
            'Pinterest': {
                channelTypes: ['Paid Social', 'Social'],
                mediaObjectives: ['Attract', 'Engage', 'Convert', 'Retain'],
                buyTypes: ['Reach', 'Traffic', 'Conversion', 'Engagement']
            },
            'DV360': {
                channelTypes: ['Display', 'Video'],
                mediaObjectives: ['Attract', 'Engage', 'Convert', 'Retain'],
                buyTypes: ['Reach', 'Traffic', 'Conversion', 'Engagement']
            }
        };

        const marketBrandAbbreviations = {
            'AU': { 'F&P': 'FPAU', 'Haier': 'HAIAU', 'Haier Home': 'HHAU', 'Home Solutions': 'HSAU', 'DCS': 'DCSAU' },
            'NZ': { 'F&P': 'FPNZ', 'Haier': 'HAINZ', 'Haier Home': 'HHNZ', 'Home Solutions': 'HSNZ' },
            'US': { 'F&P': 'FPUS', 'DCS': 'DCSUS' },
            'UK': { 'F&P': 'FPUK' },
            'CA': { 'F&P': 'FPCA', 'DCS': 'DCSCA' },
            'SG': { 'F&P': 'FPSG' },
            'GBL': { 'F&P': 'FPGBL', 'Haier': 'HAIGBL', 'Haier Home': 'HHGBL', 'Home Solutions': 'HSGBL', 'DCS': 'DCSGBL' }
        };

        const mediaObjectiveAbbr = {
            'Attract': 'ATT',
            'Engage': 'ENG',
            'Convert': 'CON',
            'Retain': 'RET'
        };

        const monthAbbr = {
            'January': 'JAN', 'February': 'FEB', 'March': 'MAR',
            'April': 'APR', 'May': 'MAY', 'June': 'JUN',
            'July': 'JUL', 'August': 'AUG', 'September': 'SEP',
            'October': 'OCT', 'November': 'NOV', 'December': 'DEC'
        };

        const buyTypeAbbr = {
            'Reach': 'REACH',
            'Traffic': 'TRAFFIC',
            'Conversion': 'CONV',
            'Engagement': 'ENG',
            'Video Views': 'VIDV'
        };

        const categoryAbbr = {
            'Cooling': 'COOL',
            'Cooking': 'COOK',
            'Fabrice Care': 'FAB',
            'Dishwashing': 'DISH',
            'Outdoor': 'OUT',
            'Ventilation': 'VENT',
            'Accessories': 'ACC',
            'Promotions': 'PROMO'
        };

        const subCategoryAbbr = {
            'Refrigeration': 'REF',
            'Wine': 'WINE',
            'Chest Freezer': 'FREEZE',
            'Ovens': 'OVEN',
            'Cooktops': 'CTOP',
            'Freestanding': 'FREE',
            'Companions': 'COMP',
            'Washing Machines': 'WASH',
            'Dryers': 'DRY',
            'Cabinets': 'CAB',
            'Grills': 'GRILL',
            'Carts': 'CART',
            'Storage': 'STOR',
            'Spare Parts': 'SPARE',
            'Accessories': 'ACC',
            'Water Filters': 'FILT',
            'Cleaning': 'CLEAN'
        };
// Authentication Functions
        function authenticate() {
            const email = document.getElementById('email-input').value;
            if (email && email.endsWith('@fisherpaykel.com')) {
                const user = {
                    email: email,
                    name: email.split('@')[0].replace('.', ' ').replace(/\b\w/g, l => l.toUpperCase())
                };
                localStorage.setItem('utmBuilderUser', JSON.stringify(user));
                document.getElementById('auth-container').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
            } else {
                showNotification('Please use a valid @fisherpaykel.com email address');
            }
        }

        function checkAuth() {
            const user = JSON.parse(localStorage.getItem('utmBuilderUser'));
            if (user && user.email) {
                document.getElementById('auth-container').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
            }
        }

        // Form Update Functions
        function updateSubCategories() {
            const category = document.getElementById('productCategory').value;
            const subCategorySelect = document.getElementById('subCategory');
            const options = subCategories[category] || [];
            
            subCategorySelect.innerHTML = '<option value="">Select...</option>';
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                subCategorySelect.appendChild(optionElement);
            });
        }

        function updateBrandOptions() {
            const market = document.getElementById('market').value;
            const brandSelect = document.getElementById('brand');
            
            brandSelect.innerHTML = '<option value="">Select...</option>';
            if (market && marketBrands[market]) {
                marketBrands[market].forEach(brand => {
                    const option = document.createElement('option');
                    option.value = brand;
                    option.textContent = brand;
                    brandSelect.appendChild(option);
                });
            }
        }

        function updateChannelDependencies() {
            const channel = document.getElementById('channel').value;
            const channelTypeSelect = document.getElementById('channelType');
            const mediaObjectiveSelect = document.getElementById('mediaObjective');
            const buyTypeSelect = document.getElementById('buyType');
            
            function updateSelect(selectElement, options = []) {
                selectElement.innerHTML = '<option value="">Select...</option>';
                options.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    optionElement.textContent = option;
                    selectElement.appendChild(optionElement);
                });
            }

            const channelConfig = channelDependencies[channel] || {
                channelTypes: [],
                mediaObjectives: [],
                buyTypes: []
            };

            updateSelect(channelTypeSelect, channelConfig.channelTypes);
            updateSelect(mediaObjectiveSelect, channelConfig.mediaObjectives);
            updateSelect(buyTypeSelect, channelConfig.buyTypes);
        }

        // Generation Functions
        function generateCampaignName() {
            const market = document.getElementById('market').value;
            const brand = document.getElementById('brand').value;
            const mediaObjective = document.getElementById('mediaObjective').value;
            const financialYear = document.getElementById('financialYear').value;
            const quarter = document.getElementById('quarter').value;
            const month = document.getElementById('month').value;

            if (!market || !brand || !mediaObjective || !financialYear || !quarter || !month) {
                showNotification('Please fill in all required fields first');
                return;
            }

            const marketBrandCode = marketBrandAbbreviations[market][brand];
            const objectiveCode = mediaObjectiveAbbr[mediaObjective];
            const monthCode = monthAbbr[month];

            const campaignName = `${marketBrandCode}_${objectiveCode}_${financialYear}_${quarter}_${monthCode}`;
            document.getElementById('campaignName').value = campaignName;
            
            updateUTMFields();
        }

        function generateAdSetName() {
            const mediaObjective = document.getElementById('mediaObjective').value;
            const buyType = document.getElementById('buyType').value;
            const category = document.getElementById('productCategory').value;
            const subCategory = document.getElementById('subCategory').value;

            if (!mediaObjective || !buyType) {
                showNotification('Please select Media Objective and Buy Type first');
                return;
            }

            const objectiveCode = mediaObjectiveAbbr[mediaObjective];
            const buyTypeCode = buyTypeAbbr[buyType];
            const categoryCode = category ? categoryAbbr[category] || '' : '';
            const subCategoryCode = subCategory ? '_' + (subCategoryAbbr[subCategory] || '') : '';
            
            const adSetName = `${objectiveCode}_${buyTypeCode}${categoryCode ? '_' + categoryCode : ''}${subCategoryCode}`;
            document.getElementById('adSet').value = adSetName;
        }
// Toggle Functions
        function toggleOtherChannel() {
            const channelSelect = document.getElementById('channel');
            const otherChannelDiv = document.getElementById('otherChannelDiv');
            if (channelSelect.value === 'other') {
                otherChannelDiv.style.display = 'block';
            } else {
                otherChannelDiv.style.display = 'none';
            }
            updateUTMFields();
        }

        function toggleManualUtm() {
            const isManual = document.getElementById('manualUtmToggle').checked;
            const utmFields = ['utmSource', 'utmMedium', 'utmCampaign', 'utmContent'];
            
            utmFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                field.readOnly = !isManual;
                if (!isManual) {
                    updateUTMFields();
                }
            });
        }

        // UTM Handling Functions
        function updateUTMFields() {
            const isManual = document.getElementById('manualUtmToggle').checked;
            if (isManual) return;

            const channel = document.getElementById('channel');
            const otherChannel = document.getElementById('otherChannel');
            const channelType = document.getElementById('channelType');
            const campaignName = document.getElementById('campaignName');
            const adName = document.getElementById('adName');
            
            const channelValue = channel.value === 'other' ? otherChannel.value : channel.value;
            
            document.getElementById('utmSource').value = formatUtmValue(channelValue);
            document.getElementById('utmMedium').value = formatUtmValue(channelType.value);
            document.getElementById('utmCampaign').value = formatUtmValue(campaignName.value);
            document.getElementById('utmContent').value = formatUtmValue(adName.value);
        }

        function formatUtmValue(value) {
            if (!value) return '';
            return value.toLowerCase()
                       .replace(/\s+/g, '_')
                       .replace(/[^a-z0-9_-]/g, '');
        }
function saveUTM() {
    // Get user info
    const user = JSON.parse(localStorage.getItem('utmBuilderUser'));
    if (!user) {
        showNotification('Please log in first');
        return;
    }

    // Get current date/time
    const timestamp = new Date().toLocaleString();
    
    // Get the UTM string and check if it exists
    const utmString = document.getElementById('generatedUtm').textContent;
    if (!utmString) {
        showNotification('Please generate a UTM URL first');
        return;
    }

    // Collect all form data
    const formData = {
        timestamp: timestamp,
        creator: user.name,
        creatorEmail: user.email,
        market: document.getElementById('market').value,
        brand: document.getElementById('brand').value,
        productCategory: document.getElementById('productCategory').value,
        subCategory: document.getElementById('subCategory').value,
        financialYear: document.getElementById('financialYear').value,
        quarter: document.getElementById('quarter').value,
        month: document.getElementById('month').value,
        channel: document.getElementById('channel').value === 'other' ? 
                document.getElementById('otherChannel').value : 
                document.getElementById('channel').value,
        channelType: document.getElementById('channelType').value,
        mediaObjective: document.getElementById('mediaObjective').value,
        buyType: document.getElementById('buyType').value,
        baseUrl: document.getElementById('baseUrl').value,
        campaignName: document.getElementById('campaignName').value,
        adName: document.getElementById('adName').value,
        utmString: utmString,
        utmSource: document.getElementById('utmSource').value,
        utmMedium: document.getElementById('utmMedium').value,
        utmCampaign: document.getElementById('utmCampaign').value,
        utmContent: document.getElementById('utmContent').value,
        utmTerm: document.getElementById('utmTerm').value
    };

    // Send to Google Apps Script webhook
    fetch('YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Add to local UTM log
            const utmLog = document.getElementById('utmLog');
            const newRow = document.createElement('tr');
            
            newRow.innerHTML = `
                <td class="utm-actions">
                    <button class="btn btn-sm btn-outline-primary me-2 small-btn" onclick="copyUTM(this)">ðŸ’¾</button>
                    <button class="btn btn-sm btn-outline-danger small-btn" onclick="deleteUTM(this)">ðŸš«</button>
                </td>
                <td>${timestamp}</td>
                <td>${user.name}</td>
                <td>${formData.campaignName}</td>
                <td class="utm-url" title="${utmString}">${utmString}</td>
            `;
            
            utmLog.appendChild(newRow);
            utmLog.parentElement.scrollTop = utmLog.parentElement.scrollHeight;
            showNotification('UTM saved successfully!');
        } else {
            showNotification('Error saving UTM: ' + data.message);
        }
    })
    .catch(error => {
        showNotification('Error saving UTM: ' + error.message);
        console.error('Save UTM error:', error);
    });
}
function endSession() {
    const utmRows = document.querySelectorAll('#utmLog tr');
    const endSaveButton = document.getElementById('endSaveButton');
    const endSaveSpinner = document.getElementById('endSaveSpinner');
    
    if (utmRows.length === 0) {
        showNotification('No UTMs to save. Please generate and save at least one UTM before ending session.');
        return;
    }

    // Show loading state
    endSaveButton.disabled = true;
    endSaveSpinner.style.display = 'inline-block';

    // Collect all UTM data with full details
    const utmData = Array.from(utmRows).map(row => {
        const user = JSON.parse(localStorage.getItem('utmBuilderUser'));
        return {
            timestamp: row.cells[1].textContent,
            creator: row.cells[2].textContent,
            creatorEmail: user.email,
            market: document.getElementById('market').value,
            brand: document.getElementById('brand').value,
            productCategory: document.getElementById('productCategory').value,
            subCategory: document.getElementById('subCategory').value,
            financialYear: document.getElementById('financialYear').value,
            quarter: document.getElementById('quarter').value,
            month: document.getElementById('month').value,
            channel: document.getElementById('channel').value === 'other' ? 
                    document.getElementById('otherChannel').value : 
                    document.getElementById('channel').value,
            channelType: document.getElementById('channelType').value,
            mediaObjective: document.getElementById('mediaObjective').value,
            buyType: document.getElementById('buyType').value,
            baseUrl: document.getElementById('baseUrl').value,
            campaignName: document.getElementById('campaignName').value,
            adName: document.getElementById('adName').value,
            utmString: row.cells[4].getAttribute('title'),
            utmSource: document.getElementById('utmSource').value,
            utmMedium: document.getElementById('utmMedium').value,
            utmCampaign: document.getElementById('utmCampaign').value,
            utmContent: document.getElementById('utmContent').value,
            utmTerm: document.getElementById('utmTerm').value
        };
    });

    // Send to Google Apps Script webhook
    fetch(process.env.WEBHOOK_URL, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Webhook-Secret': process.env.WEBHOOK_SECRET
        },
        body: JSON.stringify({ utms: utmData })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            clearForm();
            showNotification('UTMs saved successfully to Google Sheet!');
        } else {
            showNotification('Error saving UTMs: ' + data.message);
        }
    })
    .catch(error => {
        showNotification('Error saving UTMs: ' + error.message);
        console.error('Error:', error);
    })
    .finally(() => {
        // Reset loading state
        endSaveButton.disabled = false;
        endSaveSpinner.style.display = 'none';
    });
}
        function clearForm() {
            // Clear all form fields
            document.querySelectorAll('select, input').forEach(element => {
                element.value = '';
            });
            
            // Clear UTM log
            document.getElementById('utmLog').innerHTML = '';
            
            // Hide the generated UTM section
            document.getElementById('generatedUtmSection').style.display = 'none';
        
            // Reset other channel div
            document.getElementById('otherChannelDiv').style.display = 'none';
            
            // Reset UTM toggle
            document.getElementById('manualUtmToggle').checked = false;
            toggleManualUtm();
        }

        function generateUTM() {
            const baseUrl = document.getElementById('baseUrl').value;
            const utmSource = document.getElementById('utmSource').value;
            const utmMedium = document.getElementById('utmMedium').value;
            const utmCampaign = document.getElementById('utmCampaign').value;
            const utmContent = document.getElementById('utmContent').value;
            const utmTerm = document.getElementById('utmTerm').value;

            if (!baseUrl || !utmSource || !utmMedium || !utmCampaign) {
                showNotification('Please ensure all required fields are filled');
                return;
            }

            try {
                const url = new URL(baseUrl);
                url.searchParams.set('utm_source', utmSource);
                url.searchParams.set('utm_medium', utmMedium);
                url.searchParams.set('utm_campaign', utmCampaign);
                if (utmContent) url.searchParams.set('utm_content', utmContent);
                if (utmTerm) url.searchParams.set('utm_term', utmTerm);

                const generatedUtm = document.getElementById('generatedUtm');
                const generatedUtmSection = document.getElementById('generatedUtmSection');
                
                generatedUtm.textContent = url.toString();
                generatedUtmSection.style.display = 'block';
                
                generatedUtmSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } catch (error) {
                showNotification('Invalid URL format. Please check the Base URL.');
            }
        }
// UI Functions
        function showNotification(message, duration = 3000) {
            const notification = document.getElementById('notification');
            const notificationMessage = document.getElementById('notification-message');
            
            notificationMessage.textContent = message;
            notification.style.display = 'block';
            notification.classList.remove('hiding');
            
            setTimeout(() => {
                notification.classList.add('hiding');
                setTimeout(() => {
                    notification.style.display = 'none';
                    notification.classList.remove('hiding');
                }, 300);
            }, duration);
        }

        function copyToClipboard() {
            const utmString = document.getElementById('generatedUtm').textContent;
            navigator.clipboard.writeText(utmString)
                .then(() => showNotification('UTM copied to clipboard!'))
                .catch(err => showNotification('Failed to copy UTM: ' + err.message));
        }

        // UTM Management Functions
        function doPost(e) {
          try {
            // Parse the incoming data
            const data = JSON.parse(e.postData.contents);
            
            // Get the spreadsheet and sheet
            const ss = SpreadsheetApp.getActiveSpreadsheet();
            const sheet = ss.getSheetByName('UTM Log');
            
            if (!sheet) {
              throw new Error('UTM Log sheet not found');
            }
        
            // Add data to sheet
            sheet.appendRow([
              data.timestamp,
              data.creator,
              data.creatorEmail,
              data.market,
              data.brand,
              data.productCategory,
              data.subCategory,
              data.financialYear,
              data.quarter,
              data.month,
              data.channel,
              data.channelType,
              data.mediaObjective,
              data.buyType,
              data.baseUrl,
              data.campaignName,
              data.adName,
              data.utmString,
              data.utmSource,
              data.utmMedium,
              data.utmCampaign,
              data.utmContent,
              data.utmTerm
            ]);
            
            return ContentService.createTextOutput(
              JSON.stringify({ success: true, message: 'UTM saved successfully' })
            ).setMimeType(ContentService.MimeType.JSON);
            
          } catch (error) {
            return ContentService.createTextOutput(
              JSON.stringify({ success: false, message: error.toString() })
            ).setMimeType(ContentService.MimeType.JSON);
          }
        }

        function copyUTM(button) {
            const utmString = button.closest('tr').querySelector('.utm-url').title;
            navigator.clipboard.writeText(utmString)
                .then(() => showNotification('UTM copied to clipboard!'))
                .catch(err => showNotification('Failed to copy UTM: ' + err.message));
        }

        function deleteUTM(button) {
            const row = button.closest('tr');
            row.remove();
            showNotification('UTM deleted successfully');
        }

        // Initialize event listeners
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            
            // Add market change listener
            document.getElementById('market').addEventListener('change', updateBrandOptions);
            
            // Add channel change listener
            document.getElementById('channel').addEventListener('change', function() {
                updateChannelDependencies();
                toggleOtherChannel();
            });

            // Add event listeners for UTM field updates
            document.getElementById('channel').addEventListener('change', updateUTMFields);
            document.getElementById('otherChannel').addEventListener('input', updateUTMFields);
            document.getElementById('channelType').addEventListener('change', updateUTMFields);
            document.getElementById('campaignName').addEventListener('input', updateUTMFields);
            document.getElementById('adName').addEventListener('input', updateUTMFields);
        });
    </script>
</body>
</html>
