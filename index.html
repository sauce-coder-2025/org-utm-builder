<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ultimate UTM Builder</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            padding: 20px;
        }

        .container {
            max-width: 1400px !important;
            margin: 0 auto;
            padding: 0 20px;
        }

        .form-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            width: 100%; /* Add this */
        }

        .utm-log {
            position: sticky;
            top: 20px;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            height: calc(100vh - 40px);
            overflow-y: auto;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 15px 25px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            animation: slideIn 0.3s ease-out;
        }

        .auto-button {
            font-size: 10px !important;
            padding: 0px 6px !important;
            height: 20px !important;
            line-height: 20px !important;
            margin-right: 8px !important;
            background-color: #212529 !important;
            color: white !important;
            border: none !important;
        }

        .table-responsive {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .utm-table {
            width: 100%;
            table-layout: fixed;
            border-collapse: collapse;
        }
        
        .utm-table th,
        .utm-table td {
            padding: 8px;
            vertical-align: top;
            word-wrap: break-word;  /* Enable word wrapping */
            word-break: break-word; /* Prevent overflow */
        }
        
        /* Specific column widths and behaviors */
        .utm-table th:nth-child(1), /* Actions column */
        .utm-table td:nth-child(1) {
            width: 120px;
            min-width: 80px;
        }
        
        .utm-table th:nth-child(2), /* Campaign column */
        .utm-table td:nth-child(2) {
            width: 150px;
            min-width: 150px;
            white-space: normal; /* Allow text to wrap */
        }
        
        .utm-table th:nth-child(3), /* UTM Source */
        .utm-table td:nth-child(3) {
            width: 100px;
            min-width: 100px;
            white-space: normal;
        }
        
        .utm-table th:nth-child(4), /* UTM Medium */
        .utm-table td:nth-child(4) {
            width: 100px;
            min-width: 100px;
            white-space: normal;
        }
        
        .utm-table th:nth-child(5), /* UTM Content */
        .utm-table td:nth-child(5) {
            width: 120px;
            min-width: 120px;
            white-space: normal;
        }
        
        .utm-table th:nth-child(6), /* UTM URL */
        .utm-table td:nth-child(6) {
            width: 1000px;     /* Increased width */
            min-width: 400px; /* Ensure minimum width */
        }
                
        /* Style for the URL cell specifically */
        .utm-url {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap; /* Keep URLs on one line */
            display: block;
            max-width: 100%;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">Ultimate UTM Builder</h1>
        
        <!-- Authentication Container -->
        <div id="auth-container" class="text-center mb-4">
            <div class="form-section">
                <h3>Authentication</h3>
                <div class="mb-3">
                    <input type="email" class="form-control" id="email-input" placeholder="Enter your @fisherpaykel.com email">
                </div>
                <button class="btn btn-primary" onclick="authenticate()">Login</button>
            </div>
        </div>

        <!-- Notification Container -->
        <div id="notification" class="notification" style="display: none;">
            <div class="notification-content">
                <span id="notification-message"></span>
            </div>
        </div>

        <!-- Main App Container -->
        <div id="app-container" style="display: none;">
            <div class="row">
                <!-- Left Column - Form -->
                <div class="col-md-5">
<!-- Campaign Organization Section -->
                    <div class="form-section">
                        <h3>Campaign Organization</h3>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="market" class="form-label">Market</label>
                                <select class="form-select" id="market" required>
                                    <option value="">Select...</option>
                                    <option value="AU">AU</option>
                                    <option value="NZ">NZ</option>
                                    <option value="US">US</option>
                                    <option value="UK">UK</option>
                                    <option value="SG">SG</option>
                                    <option value="CA">CA</option>
                                    <option value="GBL">Global</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="brand" class="form-label">Brand</label>
                                <select class="form-select" id="brand" required>
                                    <option value="">Select...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="productCategory" class="form-label">Product Category</label>
                                <select class="form-select" id="productCategory" onchange="updateSubCategories()" required>
                                    <option value="">Select...</option>
                                    <option value="Cooling">Cooling</option>
                                    <option value="Cooking">Cooking</option>
                                    <option value="Fabric Care">Fabric Care</option>
                                    <option value="Dishwashing">Dishwashing</option>
                                    <option value="Outdoor">Outdoor</option>
                                    <option value="Ventilation">Ventilation</option>
                                    <option value="Accessories">Accessories</option>
                                    <option value="Promotions">Promotions</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="subCategory" class="form-label">Sub Category</label>
                                <select class="form-select" id="subCategory">
                                    <option value="">Select...</option>
                                </select>
                            </div>
                        </div>
                    </div>
<!-- Campaign Timing Section -->
                    <div class="form-section">
                        <h3>Campaign Timing</h3>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="financialYear" class="form-label">Financial Year</label>
                                <select class="form-select" id="financialYear" required>
                                    <option value="">Select...</option>
                                    <option value="FY24">FY24</option>
                                    <option value="FY25">FY25</option>
                                    <option value="FY26">FY26</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="quarter" class="form-label">Quarter</label>
                                <select class="form-select" id="quarter" required>
                                    <option value="">Select...</option>
                                    <option value="Q1">Q1</option>
                                    <option value="Q2">Q2</option>
                                    <option value="Q3">Q3</option>
                                    <option value="Q4">Q4</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="month" class="form-label">Month</label>
                                <select class="form-select" id="month" required>
                                    <option value="">Select...</option>
                                    <option value="January">January</option>
                                    <option value="February">February</option>
                                    <option value="March">March</option>
                                    <option value="April">April</option>
                                    <option value="May">May</option>
                                    <option value="June">June</option>
                                    <option value="July">July</option>
                                    <option value="August">August</option>
                                    <option value="September">September</option>
                                    <option value="October">October</option>
                                    <option value="November">November</option>
                                    <option value="December">December</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Campaign Details Section -->
                    <div class="form-section">
                        <h3>Campaign Details</h3>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="channel" class="form-label">Channel</label>
                                <select class="form-select" id="channel" onchange="toggleOtherChannel(); updateChannelDependencies()" required>
                                    <option value="">Select...</option>
                                    <option value="Meta">Meta</option>
                                    <option value="Tiktok">Tiktok</option>
                                    <option value="LinkedIn">LinkedIn</option>
                                    <option value="Pinterest">Pinterest</option>
                                    <option value="DV360">DV360</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="col-md-6" id="otherChannelDiv" style="display: none;">
                                <label for="otherChannel" class="form-label">Other Channel</label>
                                <input type="text" class="form-control" id="otherChannel">
                            </div>
                            <div class="col-md-6">
                                <label for="channelType" class="form-label">Channel Type</label>
                                <select class="form-select" id="channelType" required>
                                    <option value="">Select...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="mediaObjective" class="form-label">Media Objective</label>
                                <select class="form-select" id="mediaObjective" required>
                                    <option value="">Select...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="buyType" class="form-label">Buy Type</label>
                                <select class="form-select" id="buyType" required>
                                    <option value="">Select...</option>
                                </select>
                            </div>
                        </div>
                    </div>
<!-- Campaign Structure Section -->
                    <div class="form-section">
                        <h3>Campaign Structure</h3>
                        <div class="row g-3">
                            <div class="col-12">
                                <label for="baseUrl" class="form-label">Base URL</label>
                                <input type="url" class="form-control" id="baseUrl" required>
                            </div>
                            <div class="col-md-6">
                                <label for="campaignName" class="form-label">Campaign Name</label>
                                <div class="input-group-auto">
                                    <button type="button" class="auto-button btn btn-sm" onclick="generateCampaignName()">Auto</button>
                                    <input type="text" class="form-control" id="campaignName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="adSet" class="form-label">Ad Set</label>
                                <div class="input-group-auto">
                                    <button type="button" class="auto-button btn btn-sm" onclick="generateAdSetName()">Auto</button>
                                    <input type="text" class="form-control" id="adSet">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="adName" class="form-label">Ad Name</label>
                                <input type="text" class="form-control" id="adName">
                            </div>
                        </div>
                    </div>

                    <!-- UTM Parameters Section -->
                    <div class="form-section">
                        <h3>UTM Parameters</h3>
                        <div class="row g-3">
                            <div class="col-12 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="manualUtmToggle" onchange="toggleManualUtm()">
                                    <label class="form-check-label" for="manualUtmToggle">Enable manual UTM parameter input</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="utmSource" class="form-label">UTM Source</label>
                                <input type="text" class="form-control" id="utmSource" readonly>
                                <small class="text-muted">Auto-populated from Channel</small>
                            </div>
                            <div class="col-md-6">
                                <label for="utmMedium" class="form-label">UTM Medium</label>
                                <input type="text" class="form-control" id="utmMedium" readonly>
                                <small class="text-muted">Auto-populated from Channel Type</small>
                            </div>
                            <div class="col-md-6">
                                <label for="utmCampaign" class="form-label">UTM Campaign</label>
                                <input type="text" class="form-control" id="utmCampaign" readonly>
                                <small class="text-muted">Auto-populated from Campaign Name</small>
                            </div>
                            <div class="col-md-6">
                                <label for="utmContent" class="form-label">UTM Content</label>
                                <input type="text" class="form-control" id="utmContent" readonly>
                                <small class="text-muted">Auto-populated from Ad Name</small>
                            </div>
                            <div class="col-md-6">
                                <label for="utmTerm" class="form-label">UTM Term</label>
                                <input type="text" class="form-control" id="utmTerm">
                                <small class="text-muted">Manual input field</small>
                            </div>
                            <div class="col-12">
                                <button type="button" class="btn btn-primary" onclick="generateUTM()">Generate UTM</button>
                            </div>
<!-- Generated UTM Section -->
                            <div id="generatedUtmSection" style="display: none;" class="col-12 mt-4">
                                <hr class="mb-4">
                                <label class="form-label">Generated UTM URL:</label>
                                <div class="generated-utm mb-3" id="generatedUtm"></div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-success" onclick="saveUTM()">Save UTM</button>
                                        <button type="button" class="btn btn-primary" onclick="copyToClipboard()">Copy to Clipboard</button>
                                    </div>
                                    <button type="button" class="btn btn-secondary" onclick="endSession()">
                                        <span id="endSaveSpinner" class="spinner-border spinner-border-sm me-2" style="display: none;"></span>
                                        Save & End Session
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- UTM Log Column -->
                <div class="col-md-7">
                    <div class="utm-log">
                        <h3>UTM Log</h3>
                        <div class="table-responsive">
                            <table class="utm-table">
                                <thead>
                                    <tr>
                                        <th>Actions</th>
                                        <th>Campaign</th>
                                        <th>UTM Source</th>
                                        <th>UTM Medium</th>
                                        <th>UTM Content</th>
                                        <th>UTM URL</th>
                                    </tr>
                                </thead>
                                <tbody id="utmLog">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<script>
        // Constants and Data Mappings
        const subCategories = {
            'Cooling': ['Refrigeration', 'Wine', 'Chest Freezer'],
            'Cooking': ['Ovens', 'Cooktops', 'Freestanding', 'Companions'],
            'Fabric Care': ['Washing Machines', 'Dryers', 'Cabinets'],
            'Dishwashing': [],
            'Outdoor': ['Grills', 'Carts', 'Storage'],
            'Ventilation': [],
            'Accessories': ['Spare Parts', 'Accessories', 'Water Filters', 'Cleaning'],
            'Promotions': []
        };

        const marketBrands = {
            'AU': ['F&P', 'Haier', 'Haier Home', 'Home Solutions', 'DCS'],
            'NZ': ['F&P', 'Haier', 'Haier Home', 'Home Solutions'],
            'US': ['F&P', 'DCS'],
            'UK': ['F&P'],
            'CA': ['F&P', 'DCS'],
            'SG': ['F&P'],
            'GBL': ['F&P', 'Haier', 'Haier Home', 'Home Solutions', 'DCS']
        };

        const channelDependencies = {
            'Meta': {
                channelTypes: ['Paid Social', 'Social'],
                mediaObjectives: ['Attract', 'Engage', 'Convert', 'Retain'],
                buyTypes: ['Reach', 'Traffic', 'Conversion', 'Engagement']
            },
            'Tiktok': {
                channelTypes: ['Paid Social', 'Social'],
                mediaObjectives: ['Attract', 'Engage', 'Convert', 'Retain'],
                buyTypes: ['Reach', 'Traffic', 'Conversion', 'Engagement']
            },
            'LinkedIn': {
                channelTypes: ['Paid Social', 'Social'],
                mediaObjectives: ['Attract', 'Engage', 'Convert', 'Retain'],
                buyTypes: ['Reach', 'Traffic', 'Conversion', 'Engagement']
            },
            'Pinterest': {
                channelTypes: ['Paid Social', 'Social'],
                mediaObjectives: ['Attract', 'Engage', 'Convert', 'Retain'],
                buyTypes: ['Reach', 'Traffic', 'Conversion', 'Engagement']
            },
            'DV360': {
                channelTypes: ['Display', 'Video'],
                mediaObjectives: ['Attract', 'Engage', 'Convert', 'Retain'],
                buyTypes: ['Reach', 'Traffic', 'Conversion', 'Engagement']
            }
        };
// Abbreviation Mappings
        const marketBrandAbbreviations = {
            'AU': { 'F&P': 'FPAU', 'Haier': 'HAIAU', 'Haier Home': 'HHAU', 'Home Solutions': 'HSAU', 'DCS': 'DCSAU' },
            'NZ': { 'F&P': 'FPNZ', 'Haier': 'HAINZ', 'Haier Home': 'HHNZ', 'Home Solutions': 'HSNZ' },
            'US': { 'F&P': 'FPUS', 'DCS': 'DCSUS' },
            'UK': { 'F&P': 'FPUK' },
            'CA': { 'F&P': 'FPCA', 'DCS': 'DCSCA' },
            'SG': { 'F&P': 'FPSG' },
            'GBL': { 'F&P': 'FPGBL', 'Haier': 'HAIGBL', 'Haier Home': 'HHGBL', 'Home Solutions': 'HSGBL', 'DCS': 'DCSGBL' }
        };

        const mediaObjectiveAbbr = {
            'Attract': 'ATT',
            'Engage': 'ENG',
            'Convert': 'CON',
            'Retain': 'RET'
        };

        const monthAbbr = {
            'January': 'JAN', 'February': 'FEB', 'March': 'MAR',
            'April': 'APR', 'May': 'MAY', 'June': 'JUN',
            'July': 'JUL', 'August': 'AUG', 'September': 'SEP',
            'October': 'OCT', 'November': 'NOV', 'December': 'DEC'
        };

        const buyTypeAbbr = {
            'Reach': 'REACH',
            'Traffic': 'TRAFFIC',
            'Conversion': 'CONV',
            'Engagement': 'ENG',
            'Video Views': 'VIDV'
        };

        const categoryAbbr = {
            'Cooling': 'COOL',
            'Cooking': 'COOK',
            'Fabric Care': 'FAB',
            'Dishwashing': 'DISH',
            'Outdoor': 'OUT',
            'Ventilation': 'VENT',
            'Accessories': 'ACC',
            'Promotions': 'PROMO'
        };

        const subCategoryAbbr = {
            'Refrigeration': 'REF',
            'Wine': 'WINE',
            'Chest Freezer': 'FREEZE',
            'Ovens': 'OVEN',
            'Cooktops': 'CTOP',
            'Freestanding': 'FREE',
            'Companions': 'COMP',
            'Washing Machines': 'WASH',
            'Dryers': 'DRY',
            'Cabinets': 'CAB',
            'Grills': 'GRILL',
            'Carts': 'CART',
            'Storage': 'STOR',
            'Spare Parts': 'SPARE',
            'Accessories': 'ACC',
            'Water Filters': 'FILT',
            'Cleaning': 'CLEAN'
        };
// Authentication Functions
        function authenticate() {
            const email = document.getElementById('email-input').value;
            if (email && email.endsWith('@fisherpaykel.com')) {
                const user = {
                    email: email,
                    name: email.split('@')[0].replace('.', ' ').replace(/\b\w/g, l => l.toUpperCase())
                };
                localStorage.setItem('utmBuilderUser', JSON.stringify(user));
                document.getElementById('auth-container').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
            } else {
                showNotification('Please use a valid @fisherpaykel.com email address');
            }
        }

        function checkAuth() {
            const user = JSON.parse(localStorage.getItem('utmBuilderUser'));
            if (user && user.email) {
                document.getElementById('auth-container').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
            }
        }

        // Form Update Functions
        function updateSubCategories() {
            const category = document.getElementById('productCategory').value;
            const subCategorySelect = document.getElementById('subCategory');
            const options = subCategories[category] || [];
            
            subCategorySelect.innerHTML = '<option value="">Select...</option>';
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                subCategorySelect.appendChild(optionElement);
            });
        }

        function updateBrandOptions() {
            const market = document.getElementById('market').value;
            const brandSelect = document.getElementById('brand');
            
            brandSelect.innerHTML = '<option value="">Select...</option>';
            if (market && marketBrands[market]) {
                marketBrands[market].forEach(brand => {
                    const option = document.createElement('option');
                    option.value = brand;
                    option.textContent = brand;
                    brandSelect.appendChild(option);
                });
            }
        }
// Core Functions
        function updateChannelDependencies() {
            const channel = document.getElementById('channel').value;
            const channelTypeSelect = document.getElementById('channelType');
            const mediaObjectiveSelect = document.getElementById('mediaObjective');
            const buyTypeSelect = document.getElementById('buyType');
            
            function updateSelect(selectElement, options = []) {
                selectElement.innerHTML = '<option value="">Select...</option>';
                options.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    optionElement.textContent = option;
                    selectElement.appendChild(optionElement);
                });
            }

            const channelConfig = channelDependencies[channel] || {
                channelTypes: [],
                mediaObjectives: [],
                buyTypes: []
            };

            updateSelect(channelTypeSelect, channelConfig.channelTypes);
            updateSelect(mediaObjectiveSelect, channelConfig.mediaObjectives);
            updateSelect(buyTypeSelect, channelConfig.buyTypes);
            
            updateUTMFields();
        }

        function generateCampaignName() {
            const market = document.getElementById('market').value;
            const brand = document.getElementById('brand').value;
            const mediaObjective = document.getElementById('mediaObjective').value;
            const financialYear = document.getElementById('financialYear').value;
            const quarter = document.getElementById('quarter').value;
            const month = document.getElementById('month').value;

            if (!market || !brand || !mediaObjective || !financialYear || !quarter || !month) {
                showNotification('Please fill in all required fields first');
                return;
            }

            const marketBrandCode = marketBrandAbbreviations[market][brand];
            const objectiveCode = mediaObjectiveAbbr[mediaObjective];
            const monthCode = monthAbbr[month];

            const campaignName = `${marketBrandCode}_${objectiveCode}_${financialYear}_${quarter}_${monthCode}`;
            document.getElementById('campaignName').value = campaignName;
            
            updateUTMFields();
        }

        function generateAdSetName() {
            const mediaObjective = document.getElementById('mediaObjective').value;
            const buyType = document.getElementById('buyType').value;
            const category = document.getElementById('productCategory').value;
            const subCategory = document.getElementById('subCategory').value;

            if (!mediaObjective || !buyType) {
                showNotification('Please select Media Objective and Buy Type first');
                return;
            }

            const objectiveCode = mediaObjectiveAbbr[mediaObjective];
            const buyTypeCode = buyTypeAbbr[buyType];
            const categoryCode = category ? categoryAbbr[category] || '' : '';
            const subCategoryCode = subCategory ? '_' + (subCategoryAbbr[subCategory] || '') : '';
            
            const adSetName = `${objectiveCode}_${buyTypeCode}${categoryCode ? '_' + categoryCode : ''}${subCategoryCode}`;
            document.getElementById('adSet').value = adSetName;
        }
// UTM Functions
        function toggleManualUtm() {
            const isManual = document.getElementById('manualUtmToggle').checked;
            const utmFields = ['utmSource', 'utmMedium', 'utmCampaign', 'utmContent'];
            
            utmFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                field.readOnly = !isManual;
                if (!isManual) {
                    updateUTMFields();
                }
            });
        }

        function toggleOtherChannel() {
            const channelSelect = document.getElementById('channel');
            const otherChannelDiv = document.getElementById('otherChannelDiv');
            if (channelSelect.value === 'other') {
                otherChannelDiv.style.display = 'block';
            } else {
                otherChannelDiv.style.display = 'none';
                document.getElementById('otherChannel').value = '';
            }
            updateUTMFields();
        }

        function updateUTMFields() {
            if (document.getElementById('manualUtmToggle').checked) return;

            const channel = document.getElementById('channel');
            const otherChannel = document.getElementById('otherChannel');
            const channelType = document.getElementById('channelType');
            const campaignName = document.getElementById('campaignName');
            const adName = document.getElementById('adName');
            
            const channelValue = channel.value === 'other' ? otherChannel.value : channel.value;
            
            document.getElementById('utmSource').value = formatUtmValue(channelValue);
            document.getElementById('utmMedium').value = formatUtmValue(channelType.value);
            document.getElementById('utmCampaign').value = formatUtmValue(campaignName.value);
            document.getElementById('utmContent').value = formatUtmValue(adName.value);
        }

        function formatUtmValue(value) {
            if (!value) return '';
            return value.toLowerCase()
                       .replace(/\s+/g, '_')
                       .replace(/[^a-z0-9_-]/g, '');
        }
function generateUTM() {
            const baseUrl = document.getElementById('baseUrl').value;
            const utmSource = document.getElementById('utmSource').value;
            const utmMedium = document.getElementById('utmMedium').value;
            const utmCampaign = document.getElementById('utmCampaign').value;
            const utmContent = document.getElementById('utmContent').value;
            const utmTerm = document.getElementById('utmTerm').value;

            if (!baseUrl || !utmSource || !utmMedium || !utmCampaign) {
                showNotification('Please ensure all required fields are filled');
                return;
            }

            try {
                const url = new URL(baseUrl);
                url.searchParams.set('utm_source', utmSource);
                url.searchParams.set('utm_medium', utmMedium);
                url.searchParams.set('utm_campaign', utmCampaign);
                if (utmContent) url.searchParams.set('utm_content', utmContent);
                if (utmTerm) url.searchParams.set('utm_term', utmTerm);

                const generatedUtm = document.getElementById('generatedUtm');
                const generatedUtmSection = document.getElementById('generatedUtmSection');
                
                generatedUtm.textContent = url.toString();
                generatedUtmSection.style.display = 'block';
                
                generatedUtmSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } catch (error) {
                showNotification('Invalid URL format. Please check the Base URL.');
            }
        }

        function saveUTM() {
            const user = JSON.parse(localStorage.getItem('utmBuilderUser'));
            if (!user) {
                showNotification('Please log in first');
                return;
            }
        
            const utmString = document.getElementById('generatedUtm').textContent;
            if (!utmString) {
                showNotification('Please generate a UTM URL first');
                return;
            }
        
            // Create new table row with additional columns
            const utmLog = document.getElementById('utmLog');
            const newRow = document.createElement('tr');
            
            newRow.innerHTML = `
                <td>
                    <button class="btn btn-sm btn-outline-primary me-2" onclick="copyUTM(this)">💾</button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteUTM(this)">🚫</button>
                </td>
                <td>${document.getElementById('campaignName').value}</td>
                <td>${document.getElementById('utmSource').value}</td>
                <td>${document.getElementById('utmMedium').value}</td>
                <td>${document.getElementById('utmContent').value}</td>
                <td class="utm-url" title="${utmString}">${utmString}</td>
            `;
            
            utmLog.appendChild(newRow);
            showNotification('UTM saved successfully!');
        }

        function endSession() {
            const utmRows = document.querySelectorAll('#utmLog tr');
            const endSaveSpinner = document.getElementById('endSaveSpinner');
            
            if (utmRows.length === 0) {
                showNotification('No UTMs to save. Please generate and save at least one UTM before ending session.');
                return;
            }
        
            // Show loading state
            endSaveSpinner.style.display = 'inline-block';
        
            // Get user info
            const user = JSON.parse(localStorage.getItem('utmBuilderUser'));
            console.log(user,'checking_user_detail');
            if (!user) {
                showNotification('Please log in first');
                endSaveSpinner.style.display = 'none';
                return;
            }
        
            // Process each UTM entry
            Promise.all(Array.from(utmRows).map(row => {
                // Create data object for each UTM
                const data = {
                    timestamp: new Date().toISOString(),
                    creator: {
                        name: user.name,
                        email: user.email
                    },
                    market: document.getElementById('market').value,
                    brand: document.getElementById('brand').value,
                    productCategory: document.getElementById('productCategory').value,
                    subCategory: document.getElementById('subCategory').value,
                    financialYear: document.getElementById('financialYear').value,
                    quarter: document.getElementById('quarter').value,
                    month: document.getElementById('month').value,
                    channel: document.getElementById('channel').value === 'other' ? 
                            document.getElementById('otherChannel').value : 
                            document.getElementById('channel').value,
                    channelType: document.getElementById('channelType').value,
                    mediaObjective: document.getElementById('mediaObjective').value,
                    buyType: document.getElementById('buyType').value,
                    baseUrl: document.getElementById('baseUrl').value,
                    campaignName: row.cells[1].textContent,
                    adName: document.getElementById('adName').value,
                    utmString: row.querySelector('.utm-url').title,
                    utmSource: document.getElementById('utmSource').value,
                    utmMedium: document.getElementById('utmMedium').value,
                    utmCampaign: document.getElementById('utmCampaign').value,
                    utmContent: document.getElementById('utmContent').value,
                    utmTerm: document.getElementById('utmTerm').value,
                    secretKey: '{{ WEBHOOK_SECRET }}'  // Make sure this matches the yaml
                };
        
                console.log('Sending request to:', '{{ WEBHOOK_URL }}');  // Add logging
                console.log('Data being sent:', data);  // Add logging
        
                // Send to Google Apps Script
                return fetch('{{ WEBHOOK_URL }}', {  // Make sure this matches the yaml
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    mode: 'cors',
                    body: JSON.stringify(data)
                })
                .then(async response => {
                    const responseText = await response.text();
                    console.log('Response status:', response.status);
                    console.log('Response text:', responseText);
        
                    if (!response.ok) {
                        if (response.status === 405) {
                            throw new Error('Web App URL not properly configured. Please check Google Apps Script deployment.');
                        }
                        throw new Error(`HTTP error! status: ${response.status}, message: ${responseText}`);
                    }
        
                    try {
                        return JSON.parse(responseText);
                    } catch (e) {
                        console.error('JSON Parse Error:', e);
                        throw new Error(`Invalid JSON response: ${responseText}`);
                    }
                });
            }))
            .then(results => {
                const allSuccessful = results.every(result => result.success);
                if (allSuccessful) {
                    clearForm();
                    showNotification('All UTMs saved successfully to Google Sheet!');
                } else {
                    const errors = results.filter(r => !r.success).map(r => r.error).join(', ');
                    showNotification('Error saving some UTMs: ' + errors);
                }
            })
            .catch(error => {
                console.error('Full error:', error);
                showNotification('Error saving UTMs: ' + error.message);
            })
            .finally(() => {
                endSaveSpinner.style.display = 'none';
            });
        }
// Utility Functions
        function showNotification(message, duration = 3000) {
            const notification = document.getElementById('notification');
            const notificationMessage = document.getElementById('notification-message');
            
            notificationMessage.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, duration);
        }

        function copyToClipboard() {
            const utmString = document.getElementById('generatedUtm').textContent;
            navigator.clipboard.writeText(utmString)
                .then(() => showNotification('UTM copied to clipboard!'))
                .catch(err => showNotification('Failed to copy UTM: ' + err.message));
        }

        function copyUTM(button) {
            const utmString = button.closest('tr').querySelector('.utm-url').title;
            navigator.clipboard.writeText(utmString)
                .then(() => showNotification('UTM copied to clipboard!'))
                .catch(err => showNotification('Failed to copy UTM: ' + err.message));
        }

        function deleteUTM(button) {
            const row = button.closest('tr');
            row.remove();
            showNotification('UTM deleted from log');
        }

        function clearForm() {
            document.querySelectorAll('select, input').forEach(element => {
                if (element.type !== 'checkbox') {
                    element.value = '';
                }
            });
            
            document.getElementById('utmLog').innerHTML = '';
            document.getElementById('generatedUtmSection').style.display = 'none';
            document.getElementById('otherChannelDiv').style.display = 'none';
            document.getElementById('manualUtmToggle').checked = false;
            toggleManualUtm();
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            
            // Add market change listener
            document.getElementById('market').addEventListener('change', updateBrandOptions);
            
            // Add form field change listeners
            const updateFields = ['channel', 'channelType', 'campaignName', 'adName'];
            updateFields.forEach(fieldId => {
                document.getElementById(fieldId).addEventListener('change', updateUTMFields);
            });

            // Add other channel input listener
            document.getElementById('otherChannel').addEventListener('input', updateUTMFields);
        });
    </script>
</body>
</html>
